<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>

<body>
    <input type="file" id="inputImg">
    <input type="range" min="1" max="100" value="100" id="imgCompressionSlider">
    <label id="imgCompressionSliderLabel"></label>
    <label id="imgSizeLabel"></label>
    <label id="imgOriginalSizeLabel"></label>
    <label id="imgFileName"></label>
    <button id="imgRotate">Rotate</button>

    <input type="checkbox" id="enableSmoothCheckbox">


    <img id="img">
    <script>
        let rotatedNumber = 0;

        async function compressImage(blobImg, newHeight, fromat, percent, smoothing, rotate) {
            // blobImg - an image from the input type="file" that is FileList ex. theInputElementGottenById.files[0] = an blob image
            // fromat = jpeg; or png; or etc.
            // percent from 0-100%

            let bitmap = await createImageBitmap(blobImg);
            let canvas = document.createElement("canvas");
            let ctx = canvas.getContext("2d"); // Context

            if (newHeight !== '') // New width and height calc. based on the new width
            {
                let ratio = (bitmap.width / bitmap.height); // Calc. the ratio
                let newWidth = newHeight * ratio; // Calc. the new height
                canvas.width = newWidth;
                canvas.height = newHeight;

                if (rotate) {

                    ctx.setTransform(1, 0, 0, 1, 0, 0); // Reset transformation matrix before starting

                    if (rotatedNumber == 0) // 90 Degrees Clockwise
                    {
                        // Swapp the width and height for the image since it is rotated and the width becomes height and the oposite
                        canvas.width = newHeight;
                        canvas.height = newWidth;

                        ctx.translate(canvas.width, 0); // Move the "pen" to the new top-right corner
                        ctx.rotate(Math.PI / 2);// Rotate 90 degrees clockwise (must be in Radians: 90 * PI / 180)
                        rotatedNumber = 1;
                    }
                    else if (rotatedNumber == 1) // 180 Degrees
                    {
                        canvas.width = newWidth;
                        canvas.height = newHeight;
                        ctx.translate(canvas.width, canvas.height); // Move to bottom-right
                        ctx.rotate(Math.PI);// Rotate 180 degrees clockwise - // Upside down 
                        rotatedNumber = 2;
                    }
                    else if (rotatedNumber == 2)// 270 Degrees
                    {
                        canvas.width = newHeight;
                        canvas.height = newWidth;
                        // ctx.translate(0, canvas.height); // Move to bottom-left
                        ctx.translate(0, canvas.height);
                        ctx.rotate(3 * Math.PI / 2);// Rotate 270 degrees clockwise  
                        rotatedNumber = 3;
                    }
                    else if (rotatedNumber == 3) // 360 Degrees (Back to 0)
                    {
                        canvas.width = newWidth;
                        canvas.height = newHeight;
                        // ctx.translate(canvas.width, 0); // Move the "pen" to the new top-right corner
                        // ctx.rotate(2 * Math.PI);// Rotate 360 degrees clockwise  
                        rotatedNumber = 0;
                    }

                }
                ctx.imageSmoothingEnabled = smoothing; // Smoothing the image, so it is not very sharp
                ctx.drawImage(bitmap, 0, 0, newWidth, newHeight);

                let dataUrl = canvas.toDataURL(`image/${fromat}`, percent / 100);
                return dataUrl;
            }
            else {
                canvas.width = bitmap.width; // Original width and under this line ---> height
                canvas.height = bitmap.height;
                ctx.imageSmoothingEnabled = smoothing; // Smoothing the image, so it is not very sharp
                ctx.drawImage(bitmap, 0, 0, canvas.width, canvas.height);

                let dataUrl = canvas.toDataURL(`image/${fromat}`, percent / 100);
                return dataUrl;
            }



            // ctx.imageSmoothingEnabled = smoothing; // Smoothing the image, so it is not very sharp
            // ctx.drawImage(bitmap, 0, 0, canvas.width, canvas.height);

            // let dataUrl = canvas.toDataURL(`image/${fromat}`, percent / 100);
            // return dataUrl;
        }



        // 0. Executon
        async function executeCompression(newHeight, extension, rotate) {
            let imgSmoothing = document.getElementById('enableSmoothCheckbox').value; // Smoothing checkbox true / false. So the image is not sharp when downscaled
            let img = document.getElementById('inputImg').files[0]; // The first file
            let compPercent = document.getElementById('imgCompressionSlider').value; // The percantage
            let imgCompressed = await compressImage(img, newHeight, extension, compPercent, imgSmoothing, rotate); // img = blob; newHeight (ex.) = 750; extension = png; jpeg; webp; compPercent = (from 0 to 100); imgSmoothing = true / false; rotate = true / false; 

            document.getElementById('img').src = imgCompressed; // Assign the image so to be shown to the user
            document.getElementById('imgCompressionSliderLabel').textContent = 'Compression to:' + compPercent + '%'; // Update the label that shows the percantage
            //    document.getElementById('imgSizeLabel').textContent = Math.ceil(((imgCompressed.length*6)/8)/1024) + 'kb'; // Update the label that shows the image size
            document.getElementById('imgSizeLabel').textContent = 'Curr. Size:' + (imgCompressed.length * 0.75 / 1024).toFixed(1) + 'kb'; // Update the label that shows the image size. 6/8 = 0.75 also handles the padding of base64 string. there is == etc. - 1,024 Bytes: 1 Kilobyte (KB).
            //    document.getElementById('imgOriginalSizeLabel').textContent = 'Orig. Size:' + img.size.toLocaleString() + 'kb'; // The original size
            document.getElementById('imgOriginalSizeLabel').textContent = 'Orig. Size:' + (img.size / 1048576).toFixed(2) + 'MB'; // The original size - from bytes to MB - 1,048,576 Bytes = 1 Megabyte (MB). 
            document.getElementById('imgFileName').textContent = 'File Name:' + img.name;
        }


        // 1. The inputIMG
        document.getElementById('inputImg').addEventListener('change', async (e) => {
            // let img = e.target.files[0];
            // console.log('File Name: ', img.name)
            // console.log('Original Size: ', img.size.toLocaleString())

            // let imgCompressed = await compressImage(img, '750', 'webp', 75, false) // set to 75%
            // let compSize = atob(imgCompressed.split(",")[1]).length; // The Compressed size in kb
            // console.log('Compressed Size in kb: ', compSize.toLocaleString())
            // //console.log(imgCompressed)

            // document.getElementById('img').src = imgCompressed;

            await executeCompression(750, 'webp', false);
        });




        // 2. The slider
        document.getElementById('imgCompressionSlider').addEventListener('input', async (e) => {

            await executeCompression(750, 'webp', false);
        });



        // 3. The checkbox
        document.getElementById('enableSmoothCheckbox').addEventListener('check', async (e) => {
            await executeCompression(newHeight, 'webp', false);
        });

        // 4. Img Rotate
        document.getElementById('imgRotate').addEventListener('click', async (e) => {
            await executeCompression(750, 'webp', true);
        });
        // https://stackoverflow.com/questions/14672746/how-to-compress-an-image-via-javascript-in-the-browser

    </script>

</body>

</html>